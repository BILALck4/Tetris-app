# Define stages in the pipeline
stages:
  - build
  - test
  - docs
  - dist
  - deploy

# Build stage: Compile the Java code using Ant
build:
  stage: build
  image: openjdk:17
  before_script:
    - apt-get update && apt-get install -y ant
  script:
    - echo "Building the project with Ant..."
    - ant compile
  only:
    - main
    - develop
  artifacts:
    paths:
      - output/
    expire_in: 1 week

# Test stage: Run tests using JUnit and Ant
test:
  stage: test
  script:
    - echo "Running tests with Ant..."
    - ant test
  only:
    - main
    - develop
  dependencies:
    - build  # Retrieve artifacts generated by the build job
  artifacts:
    paths:
      - test-reports/
    reports:
      junit: test-reports/TESTS-TestSuites.xml

# Javadoc stage: Generate Javadoc using Ant
javadoc:
  stage: docs
  script:
    - echo "Generating Javadoc with Ant..."
    - ant javadoc
  only:
    - main
    - develop
  dependencies:
    - build  # Use compiled classes from the build stage
  artifacts:
    paths:
      - javadoc/
    expire_in: 1 week

# Distribution stage: Package the project into a JAR file
dist:
  stage: dist
  script:
    - echo "Packaging the project into a JAR file with Ant..."
    - ant dist
  only:
    - main
    - develop
  dependencies:
    - build  # Use artifacts generated from the build job
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

# Deploy stage: Deploy the project to a server
deploy:
  stage: deploy
  script:
    - echo "Deploying the project..."
    # Add your deployment commands here (e.g., scp, rsync, or other deployment tools)
    - scp dist/Tetris.jar e22409386@gitlab-depinfo-2024.univ-brest.fr:/home/e22409386/tetris_project/
  only:
    - main  # Deploy only when changes are merged into the main branch
  dependencies:
    - dist  # Use the JAR file created in the dist stage
  environment:
    name: production
    url: http://your-production-url
  when: manual  # Set this to 'manual' if you want to trigger deployments manually
